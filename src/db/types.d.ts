import { Activity, Domain, RawActivity } from "../models/activity";
import { DefiniteTimeRange, TimeRange } from "../models/time";

/** Object representing a segment of web browsing activity stored in DB */
export interface ActivityTableRecord {
  id?: number; // auto-generated by DB
  domain: string;
  path: string;
  startTime: number;
  endTime: number;
}

/** Object representing a domain & its metadata stored in DB */
export interface DomainTableRecord {
  id: string; // domain
  favIconUrl: string;
}

/** Object representing a title stored in DB */
export interface TitleTableRecord {
  id: string; // url
  title: string;
}

export interface DatabaseRecords {
  activity: ActivityTableRecord[];
  domain: DomainTableRecord[];
  title: TitleTableRecord[];
}

/** Service for managing with activity records */
export interface ActivityService {
  /**
   * Creates & stores an activity record
   * @param activity raw activity data
   */
  createActivityRecord(activity: RawActivity): Promise<void>;

  /**
   * Deletes a list of activity records
   * @param recordId List of activity records IDs to be deleted
   */
  deleteActivityRecords(recordIds: number[]): Promise<void>;

  /**
   * Fetches all visited domains found in activity records
   * @returns Collection of all visited domains
   */
  fetchAllActivityDomains(): Promise<Record<string, Domain>>;

  /**
   * Fetches all stored activity records
   * @returns Collection of all activity records
   */
  fetchAllActivityRecords(): Promise<Activity[]>;

  /**
   * Fetches all stored activity records that matches the query
   * @returns Collection of activity records
   */
  fetchActivityRecords(query: TimeRange): Promise<Activity[]>;

  /**
   * Fetches time range of all stored activity records
   * @returns Time Range composed of `startTime` of the oldest activity record
   * & the current time
   */
  fetchActivityTimeRange(): Promise<DefiniteTimeRange | null>;
}

/** Service for exporting & importing activity records */
export interface DataMigrationService {
  /**
   * Export all table records in database
   * @returns object containing all records keyed by their respective table name
   */
  exportDatabaseRecords(): Promise<DatabaseRecords>;

  /**
   * Import table records into database (overwrites existing records)
   */
  importDatabaseRecords(records: DatabaseRecords): Promise<void>;
}

/** Service for managing, exporting & importing activity records */
export interface DatabaseService
  extends ActivityService,
    DataMigrationService {}
